# Enhanced Nginx Configuration for FibreFlow Agent Workforce
# Features: Response Caching, Compression, Rate Limiting, Monitoring
#
# Deploy: Copy to /etc/nginx/sites-available/fibreflow
#         Test with: nginx -t
#         Reload: systemctl reload nginx

# Rate limiting zones (outside server block)
# Allow 10 requests per second per IP, with burst capacity of 20
limit_req_zone $binary_remote_addr zone=agent_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=health_limit:5m rate=30r/s;

# Response cache configuration
# Stores responses for 10 minutes to reduce Claude API costs
proxy_cache_path /var/cache/nginx/agent_cache
    levels=1:2
    keys_zone=agent_cache:50m
    max_size=1g
    inactive=60m
    use_temp_path=off;

server {
    listen 80;
    server_name app.fibreflow.app;

    # Logging with detailed format
    access_log /var/log/nginx/fibreflow_access.log combined;
    error_log /var/log/nginx/fibreflow_error.log warn;

    # Custom log format for debugging cache hits/misses
    log_format cache_status '$remote_addr - $remote_user [$time_local] '
                           '"$request" $status $body_bytes_sent '
                           '"$http_referer" "$http_user_agent" '
                           'cache:$upstream_cache_status';

    # ============================================
    # Health Check Endpoint (Uncached, Rate Limited)
    # ============================================
    location ~ ^/api/agent/(quick|brain)/health {
        # Higher rate limit for health checks
        limit_req zone=health_limit burst=50 nodelay;

        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Short timeouts for health checks
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;

        # Never cache health checks
        add_header Cache-Control "no-store, no-cache, must-revalidate";
        add_header X-Cache-Status "BYPASS" always;
    }

    # ============================================
    # Superior Brain Agent (Smart Mode - Port 8001)
    # ============================================
    location /api/agent/brain {
        # Rate limiting: 10 req/s per IP, burst 20
        limit_req zone=agent_limit burst=20 nodelay;

        # Proxy to Superior Brain API
        proxy_pass http://127.0.0.1:8001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Extended timeouts for AI processing
        proxy_connect_timeout 90s;
        proxy_send_timeout 90s;
        proxy_read_timeout 90s;

        # Response Caching Configuration
        # WARNING: Only cache GET requests with no auth headers
        proxy_cache agent_cache;
        proxy_cache_methods GET HEAD;

        # Cache key: method + URI + request body (for POST with identical queries)
        proxy_cache_key "$request_method$request_uri$request_body";

        # Cache successful responses for 10 minutes
        proxy_cache_valid 200 10m;
        proxy_cache_valid 404 1m;

        # Use stale cache if backend is down
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503;
        proxy_cache_background_update on;
        proxy_cache_lock on;

        # Add cache status header for debugging
        add_header X-Cache-Status $upstream_cache_status always;
        add_header X-Cache-Key "$request_method$request_uri" always;

        # Gzip compression (30x reduction for JSON responses)
        gzip on;
        gzip_comp_level 6;
        gzip_types application/json text/plain text/html text/css application/javascript;
        gzip_min_length 1000;
        gzip_vary on;

        # CORS headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' '*' always;

        # Handle OPTIONS preflight
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

    # ============================================
    # Dual Database Agent (Quick Mode - Port 8000)
    # ============================================
    location /api/agent/quick {
        # Rate limiting
        limit_req zone=agent_limit burst=20 nodelay;

        # Proxy to Dual Agent API
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Shorter timeouts for quick mode
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Response Caching (more aggressive for quick mode)
        proxy_cache agent_cache;
        proxy_cache_methods GET HEAD;
        proxy_cache_key "$request_method$request_uri$request_body";
        proxy_cache_valid 200 15m;  # 15 minutes for quick queries
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503;
        add_header X-Cache-Status $upstream_cache_status always;

        # Gzip compression
        gzip on;
        gzip_comp_level 6;
        gzip_types application/json text/plain text/html;
        gzip_min_length 1000;

        # CORS
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' '*' always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

    # ============================================
    # Legacy Endpoint (Root) - Port 8000
    # ============================================
    location / {
        # Rate limiting
        limit_req zone=agent_limit burst=20 nodelay;

        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Gzip compression
        gzip on;
        gzip_comp_level 6;
        gzip_types application/json text/plain text/html text/css application/javascript;
        gzip_min_length 1000;

        # CORS
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    }

    # ============================================
    # Nginx Status Endpoint (for monitoring)
    # Only accessible from localhost
    # ============================================
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
}

# SSL Configuration (certbot will add this automatically)
# After running: certbot --nginx -d app.fibreflow.app
